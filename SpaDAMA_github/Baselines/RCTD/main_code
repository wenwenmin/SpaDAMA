import scanpy as sc
import pandas as pd
import os
import numpy as np
import tracemalloc
import time
from rpy2.robjects import r, pandas2ri
from rpy2.robjects.packages import importr
import rpy2.robjects as robjects
print(robjects.r('R.home()'))

from rpy2.robjects.packages import importr
spacexr = importr("spacexr")
print("spacexråŠ è½½æˆåŠŸï¼")
# å¯ç”¨ pandas ä¸ R çš„è‡ªåŠ¨è½¬æ¢
pandas2ri.activate()
import re
def clean_celltype_labels(labels):
    # æ›¿æ¢æ‰éå­—æ¯æ•°å­—æˆ–ä¸‹åˆ’çº¿çš„å­—ç¬¦ä¸ºä¸‹åˆ’çº¿
    return labels.apply(lambda x: re.sub(r"[^\w\s-]", "_", str(x)))

def main(a, b, cell_key, x, y):
    for i in range(a, b):
        print("â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”ç¬¬" + str(i) + "ä¸ªæ•°æ®â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”")
        start_time = time.time()
        tracemalloc.start()
        """E:\ç¬¬ä¸€æ¬¡é¡¹ç›®â€”â€”MACD\MACD_github\Datasets\Real_datasets\dataset1\scRNA.h5ad"""
        sc_h5ad_fp = f'E:\ç¬¬ä¸€æ¬¡é¡¹ç›®â€”â€”MACD\MACD_github\Datasets\Real_datasets\dataset{i}\\scRNA.h5ad'
        st_h5ad_fp = f'E:\ç¬¬ä¸€æ¬¡é¡¹ç›®â€”â€”MACD\MACD_github\Datasets\Real_datasets\dataset{i}\\Spatial.h5ad'
        out_dir = f'E:\ç¬¬ä¸€æ¬¡é¡¹ç›®â€”â€”MACD\MACD_github\Baselines\RCTD\Result\dataset{i}'
        os.makedirs(out_dir, exist_ok=True)
        out_matrix_norm_fp = os.path.join(out_dir, "result.csv")
        print(out_matrix_norm_fp)
        # === 1. è¯»å– ST æ•°æ® ===
        adata_st = sc.read_h5ad(st_h5ad_fp)

        # æ£€æŸ¥ç©ºé—´åæ ‡æ˜¯å¦åœ¨ obsm
        if "spatial" in adata_st.obsm:
            st_locations = pd.DataFrame(adata_st.obsm["spatial"], index=adata_st.obs_names, columns=["X", "Y"])
        else:
            st_locations = adata_st.obs[[x, y]]  # fallbackï¼šç¡®ä¿ä½ æœ‰ X/Y åˆ—

        # counts: åŸºå›  Ã— ç©ºé—´ç‚¹
        # st_counts = pd.DataFrame(adata_st.X.T, index=adata_st.var_names, columns=adata_st.obs_names)
        st_counts = pd.DataFrame(
            (adata_st.X.toarray() if hasattr(adata_st.X, "toarray") else adata_st.X).T,
            index=adata_st.var_names,
            columns=adata_st.obs_names
        )

        # === 2. è¯»å– scRNA æ•°æ® ===
        adata_sc = sc.read_h5ad(sc_h5ad_fp)

        # counts: åŸºå›  Ã— å•ç»†èƒ
        # sc_counts = pd.DataFrame(adata_sc.X.T, index=adata_sc.var_names, columns=adata_sc.obs_names)
        # sc_counts = pd.DataFrame(
        #     (adata_sc.X.toarray() if hasattr(adata_sc.X, "toarray") else adata_sc.X).T,
        #     index=adata_sc.var_names,
        #     columns=adata_sc.obs_names
        # )
        sc_raw = adata_sc.X.toarray() if hasattr(adata_sc.X, "toarray") else adata_sc.X
        sc_counts = pd.DataFrame(
            np.rint(sc_raw).astype(int).T,
            index=adata_sc.var_names,
            columns=adata_sc.obs_names
        )

        # ç»†èƒç±»å‹æ ‡ç­¾ï¼Œæ›¿æ¢æˆä½ å®é™…çš„åˆ—å
        cell_type_col = cell_key  # or "celltype_major", etc.
        assert cell_type_col in adata_sc.obs.columns, f"{cell_type_col} not found in scRNA obs"
        sc_labels = adata_sc.obs[cell_type_col]
        print("ğŸ§¬ Unique cell types (before cleaning):", sc_labels.unique())
        sc_labels_cleaned = clean_celltype_labels(sc_labels)
        print("ğŸ§¬ Cleaned cell types:", sc_labels_cleaned.unique())

        # === 3. åŠ è½½ R åŒ… ===
        spacexr = importr("spacexr")

        # === 4. å°†æ•°æ®ä¼ å…¥ R ===
        r.assign("st_counts", pandas2ri.py2rpy(st_counts))
        r.assign("st_locations", pandas2ri.py2rpy(st_locations))
        r.assign("sc_counts", pandas2ri.py2rpy(sc_counts))
        # r.assign("sc_labels", pandas2ri.py2rpy(sc_labels))
        r.assign("sc_labels", pandas2ri.py2rpy(sc_labels_cleaned))

        # === 5. åœ¨ R ä¸­è¿è¡Œ RCTD ===

        safe_out_path = out_matrix_norm_fp.replace("\\", "/")

        # ç”¨ R è°ƒç”¨ RCTD åˆ†æ
        r(f'''
        options(error = function() {{ traceback(2); quit(save = "no", status = 1) }})

        library(spacexr)
        print("ğŸ“Œ spacexr loaded")

        print("ğŸ“Œ Creating Reference object...")
        sc_reference <- Reference(counts = sc_counts, cell_types = sc_labels)
        print("âœ… Reference created")

        print("ğŸ“Œ Creating SpatialRNA object...")
        st_data <- SpatialRNA(counts = st_counts, coords = st_locations, require_int = FALSE)
        print("âœ… SpatialRNA created")

        print("ğŸ“Œ Running create.RCTD...")
        myRCTD <- create.RCTD(st_data, sc_reference, max_cores = 1, CELL_MIN_INSTANCE = 1)
        print("âœ… RCTD object created")

        print("ğŸ“Œ Running run.RCTD...")
        myRCTD <- run.RCTD(myRCTD, doublet_mode = "doublet")
        print("âœ… run.RCTD complete")

        print("ğŸ“Œ Extracting results...")
        weights <- myRCTD@results$weights
        norm_weights <- normalize_weights(weights)
        print("âœ… Weights normalized")

        print("ğŸ“Œ Saving results...")
        write.csv(as.matrix(norm_weights), file = "{safe_out_path}", quote = FALSE)
        print("âœ… Results saved")
        ''')

        print("âœ… RCTD è¿è¡Œå®Œæˆï¼Œç»“æœä¿å­˜è‡³ï¼š", out_matrix_norm_fp)
        end_time = time.time()  # è®°å½•ç»“æŸæ—¶é—´
        total_time = end_time - start_time  # è®¡ç®—æ€»æ—¶é—´
        print(f"novoSpaRC Total time taken: {total_time:.2f} seconds")  # æ‰“å°æ€»æ—¶é—´
        current, peak = tracemalloc.get_traced_memory()
        print(f"[Peak Memory] Current: {current / 1024 / 1024:.2f} MB; Peak: {peak / 1024 / 1024:.2f} MB")

        tracemalloc.stop()


for start, end, cell_type_column, x_column, y_column in [
    # (1, 2, 'cell_type', 'x', 'y'),
    # (2, 3, 'cell_types', 'array_row', 'array_col'),
    (3, 4, 'celltype_new', 'spatial_x', 'spatial_y'),

    (6, 7, 'label', 'x', 'y')
]:
    main(start, end, cell_type_column, x_column, y_column)
